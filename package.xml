<?xml version="1.0" encoding="utf-8"?>
<package name="ROFSim" displayName="ROF SyncroSim Package" version="0.4.0">

  <!-- Transformers -->
  <transformers>

    <transformer name="Primary" isPrimary="True">

      <include>
        <transformer name="corestime_Runtime" />
        <transformer name="LoadSpadesOutputs" />
        <transformer name="makeLCCFromCohortData" />
        <transformer name="RunCaribouHabitatModel" />
      </include>

      <datafeeds>

        <!-- Project Datafeeds -->

        <datafeed name="SpaDESSimObject" displayName="SpaDES Sim Objects" dataScope="Project">
          <datasheets>
            <datasheet name="SpaDESSimObject" displayName="SpaDES Sim Objects" valueMember="SpaDESSimObjectID" displayMember="Name">
              <columns>
                <column name="SpaDESSimObjectID" dataType="Integer" isPrimary="True" />
                <column name="ProjectID" dataType="Integer" />
                <column name="Name" displayName="Sim Object Name" dataType="String" />
                <column name="Description" dataType="String" isOptional="True" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <!-- datafeed name="Variable" displayName="Tabular Variables" dataScope="Project">
          <datasheets>
            <datasheet name="Variable" displayName="Variables" valueMember="VariableID" displayMember="Name">
              <columns>
                <column name="VariableID" dataType="Integer" isPrimary="True" />
                <column name="ProjectID" dataType="Integer" />
                <column name="Name" dataType="String" />
                <column name="Description" dataType="String" isOptional="True" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed -->

        <datafeed name="Rasters" displayName="Rasters" dataScope="Project">
          <datasheets>
            <datasheet name="Rasters" displayName="Rasters" valueMember="RastersID" displayMember="Name">
              <columns>
                <column name="RastersID" dataType="Integer" isPrimary="True" />
                <column name="ProjectID" dataType="Integer" />
                <column name="Name" displayName="Variable Name" dataType="String" />
                <column name="Description" dataType="String" isOptional="True" />
                <column name="SpaDESSimObject " displayName="SpaDES Sim Object" dataType="Integer" validationType="Datasheet" formula1="SpaDESSimObject" isOptional="True" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <datafeed name="Polygons" displayName="Polygons" dataScope="Project">
          <datasheets>
            <datasheet name="Polygons" displayName="Polygons" valueMember="PolygonsID" displayMember="Name">
              <columns>
                <column name="PolygonsID" dataType="Integer" isPrimary="True" />
                <column name="ProjectID" dataType="Integer" />
                <column name="Name" displayName="Variable Name" dataType="String" />
                <column name="Description" dataType="String" isOptional="True" />
                <column name="SpaDESSimObject " displayName="SpaDES Sim Object" dataType="Integer" validationType="Datasheet" formula1="SpaDESSimObject" isOptional="True" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <datafeed name="CaribouRange" displayName="Caribou Ranges" dataScope="Project">
          <datasheets>
            <datasheet name="CaribouRange" displayName="Caribou Ranges" valueMember="CaribouRangeID" displayMember="Name">
              <columns>
                <column name="CaribouRangeID" dataType="Integer" isPrimary="True" />
                <column name="ProjectID" dataType="Integer" />
                <column name="Name" dataType="String" allowDbNull="False" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <datafeed name="Season" displayName="Seasons" dataScope="Project">
          <datasheets>
            <datasheet name="Season" displayName="Seasons" valueMember="SeasonID" displayMember="Name">
              <columns>
                <column name="SeasonID" dataType="Integer" isPrimary="True" />
                <column name="ProjectID" dataType="Integer" />
                <column name="Name" dataType="String" allowDbNull="False" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <!-- Scenario Datafeeds -->

        <!-- Spades -->

        <datafeed name="SpaDESGeneral" displayName="General" dataScope="Scenario">
          <datasheets>
            <datasheet name="SpaDESGeneral" displayName="General">
              <columns>
                <column name="SpaDESGeneralID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="Iteration" dataType="Integer" validationType="WholeNumber" validationCondition="Greater" formula1="0" format="d" />
                <column name="Filename" displayName="SpaDES File" dataType="String" allowDbNull="False" isExternalFile="True" externalFileFilter="SpaDES QS file |*.qs" externalFileAbsolute="True" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <!-- NON-Spades -->

        <datafeed name="RunControl" displayName="Run Control" dataScope="Scenario">
          <datasheets>
            <datasheet name="RunControl" displayName="Run Control" isSingleRow="True">
              <columns>
                <column name="RunControlID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="MinimumIteration" isVisible="False" displayName="Minimum Iteration" dataType="Integer" defaultValue="1" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="1" format="d" />
                <column name="MaximumIteration" displayName="Total Iterations" dataType="Integer" defaultValue="1" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="1" format="d" />
                <column name="MinimumTimestep" displayName="Minimum Timestep" dataType="Integer" defaultValue="0" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="0" format="d" />
                <column name="MaximumTimestep" displayName="Maximum Timestep" dataType="Integer" defaultValue="0" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="0" format="d" />
                <column name="OutputFrequency" displayName="Output Frequency (Timesteps)" dataType="Integer" defaultValue="1" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="1" format="d" />
                <column name="IncludeTimesteps" displayName="Include Timesteps" dataType="String" isOptional="True"/>
              </columns>
              <validations>
                <validation validationType="LessEqual" columns="MinimumIteration|MaximumIteration" />
                <validation validationType="LessEqual" columns="MinimumTimestep|MaximumTimestep" />
              </validations>
            </datasheet>
          </datasheets>
        </datafeed>

        <!--datafeed name="DataSummary" displayName="Data Summary" dataScope="Scenario">
          <datasheets>
            <datasheet name="DataSummary" displayName="Data Summary" viewFilterColumn="VariableID">
              <columns>
                <column name="DataSummaryID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="Iteration" dataType="Integer" validationType="WholeNumber" validationCondition="Greater" formula1="0" format="d" isOptional="True" />
                <column name="Timestep" dataType="Integer" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="0" isOptional="True" />
                <column name="VariableID" displayName="Variable" dataType="Integer" validationType="Datasheet" formula1="Variable" />
                <column name="Value" dataType="Integer" />
                <column name="Source" dataType="String" isOptional="True" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed-->

        <datafeed name="RasterFile" displayName="Raster Data" dataScope="Scenario">
          <datasheets>
            <datasheet name="RasterFile" displayName="Rasters">
              <columns>
                <column name="RasterFileID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="TransformerID" displayName="Transformer" dataType="Integer" validationType="Datasheet" formula1="core_Transformer" isCompositeIndex="True" isOptional="True" />
                <column name="Iteration" dataType="Integer" validationType="WholeNumber" validationCondition="Greater" formula1="0" format="d" isOptional="True" />
                <column name="Timestep" dataType="Integer" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="0" isOptional="True" />
                <column name="RastersID" displayName="Variable Name" dataType="Integer" validationType="Datasheet" formula1="Rasters" />
                <column name="Filename" dataType="String" isExternalFile="True" isRaster="True" allowDbNull="True" externalFileFilter="Rasters files (*.tif)|*.tif" bandColumn="Band" bandFilterColumn="RastersID" />
                <column name="Band" dataType="Integer" isOptional="True" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <datafeed name="ExternalFile" displayName="Polygon Data" dataScope="Scenario">
          <datasheets>
            <datasheet name="ExternalFile" displayName="External Files">
              <columns>
                <column name="ExternalFileID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="TransformerID" displayName="Transformer" dataType="Integer" validationType="Datasheet" formula1="core_Transformer" isCompositeIndex="True" isOptional="True" />
                <column name="Iteration" dataType="Integer" validationType="WholeNumber" validationCondition="Greater" formula1="0" format="d" isOptional="True" />
                <column name="Timestep" dataType="Integer" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="0" isOptional="True" />
                <column name="PolygonsID" displayName="File Variable" dataType="Integer" validationType="Datasheet" formula1="Polygons" />
                <column name="File" dataType="String" isExternalFile="True" allowDbNull="True" includeExtensions="shp|shx|dbf|prj" externalFileFilter="ShapeFiles (*.shp)|*.shp" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

      </datafeeds>

    </transformer>

    <transformer name="LoadSpadesOutputs" isRunnable="True" displayName="Spades Import" programName="Rscript" programArguments="load_spades_outputs.R">

      <datafeeds>

        <!--datafeed name="SpaDESRuntimeVariables" displayName="Runtime Variables" dataScope="Scenario">
          <datasheets>
            <datasheet name="SpaDESRuntimeVariables" displayName="Runtime Variables">
              <columns>
                <column name="SpaDESRuntimeVariablesID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="VariableID" displayName="Variable" dataType="Integer" validationType="Datasheet" formula1="Variable" allowDbNull="False" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed-->

        <datafeed name="SpaDESRuntimeRasters" displayName="Rasters" dataScope="Scenario">
          <datasheets>
            <datasheet name="SpaDESRuntimeRasters" displayName="Rasters">
              <columns>
                <column name="SpaDESRuntimeRastersID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="RastersID" displayName="Raster Variable" dataType="Integer" validationType="Datasheet" formula1="Rasters" allowDbNull="False" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <datafeed name="SpaDESRuntimeFiles" displayName="Shape Files" dataScope="Scenario">
          <datasheets>
            <datasheet name="SpaDESRuntimeFiles" displayName="Shape Files">
              <columns>
                <column name="SpaDESRuntimeFilesID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="PolygonsID" displayName="File Variable" dataType="Integer" validationType="Datasheet" formula1="Polygons" allowDbNull="False" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

      </datafeeds>

      <pipeline>

        <datafeed name="RunControl" />
        <datafeed name="SpaDESGeneral" />
        <datafeed name="SpaDESRuntimeRasters" />
        <datafeed name="SpaDESRuntimeFiles" />

      </pipeline>

    </transformer>

    <transformer name="makeLCCFromCohortData" displayName="Generate LCC from Cohort Data" isRunnable="True" programName="Rscript" programArguments="makeLCCFromCohortData.R">

      <pipeline>

        <datafeed name="RunControl" />
        <datafeed name="SpaDESGeneral" />

      </pipeline>

    </transformer>

    <transformer name="RunCaribouHabitatModel" displayName="Caribou Habitat" isRunnable="True" programName="Rscript" className="SyncroSim.StochasticTime.StochasticTimeTransformer" classAssembly="SyncroSim.StochasticTime" configurationSheet="ROFSim_RunControl" programArguments="run_caribou_model.R">

      <datafeeds>

        <!-- Input Datafeeds -->
        
        <datafeed name="RunCaribouRange" displayName="Caribou Range" dataScope="Scenario">
          <datasheets>
            <datasheet name="RunCaribouRange" displayName="Caribou Range">
              <columns>
                <column name="RunCaribouRangeID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="Range" displayName="Range Name" dataType="Integer" validationType="Datasheet" formula1="CaribouRange" allowDbNull="False" />
                <column name="CoeffRange" displayName="Coeff Range Name" dataType="Integer" validationType="Datasheet" formula1="CaribouRange" allowDbNull="False"/>
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <datafeed name="HabitatModelOptions" displayName="Habitat Model Options" dataScope="Scenario">
          <datasheets>
            <datasheet name="HabitatModelOptions" displayName="Habitat Model Options" isSingleRow="True">
              <columns>
                <column name="ScenarioID" dataType="Integer" isPrimary="True" />
                <column name="PadProjPoly" displayName="Project Polygon Padding" dataType="Boolean" />
                <column name="PadFocal" displayName="Focal Padding" dataType="Boolean" />
                <column name="doScale" displayName="Scale" dataType="Boolean" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <datafeed name="CaribouDataSource" displayName="Data Sources" dataScope="Scenario">
          <datasheets>
            <datasheet name="CaribouDataSource" displayName="Data Sources" isSingleRow="True">
              <columns>
                <column name="CaribouDataSourceID" dataType="Integer" isPrimary="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="LandCoverRasterID" displayName="Land Cover (Raster)" dataType="Integer" validationType="Datasheet" formula1="Rasters" allowDbNull="False" />
                <column name="ProjectShapeFileID" displayName="Project Area (Polygon)" dataType="Integer" validationType="Datasheet" formula1="Polygons" allowDbNull="False" />
                <column name="EskerRasterID" displayName="Eskers (Raster)" dataType="Integer" validationType="Datasheet" formula1="Rasters" allowDbNull="True" />
                <column name="EskerShapeFileID" displayName="Eskers (Polygon)" dataType="Integer" validationType="Datasheet" formula1="Polygons" allowDbNull="True" />
                <column name="LinearFeatureRasterID" displayName="Linear Feature (Raster)" dataType="Integer" validationType="Datasheet" formula1="Rasters" allowDbNull="True" />
                <column name="LinearFeatureShapeFileID" displayName="Linear Feature (Polygon)" dataType="Integer" validationType="Datasheet" formula1="Polygons" allowDbNull="True" />
                <column name="AgeRasterID" displayName="Age (Raster)" dataType="Integer" validationType="Datasheet" formula1="Rasters" allowDbNull="True" />
                <column name="NaturalDisturbanceRasterID" displayName="Natural Disturbances (Raster)" dataType="Integer" validationType="Datasheet" formula1="Rasters" allowDbNull="True" />
                <column name="AnthropogenicRasterID" displayName="Anthropogenic Disturbances (Raster)" dataType="Integer" validationType="Datasheet" formula1="Rasters" allowDbNull="True" />
                <column name="HarvestRasterID" displayName="Harvest (Raster)" dataType="Integer" validationType="Datasheet" formula1="Rasters" allowDbNull="True" />
                <!-- <column name="FRIRasterID" displayName="FRI (Raster)" dataType="Integer" validationType="Datasheet" formula1="Rasters" allowDbNull="False" /> -->
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

        <!-- Outputs Datafeeds -->

        <datafeed name="OutputSpatialHabitat" displayName="Output Habitat Spatial" dataScope="Scenario" isOutput="True">
          <datasheets>
            <datasheet name="OutputSpatialHabitat" displayName="Output Habitat Spatial">
              <columns>
                <column name="OutputSpatialHabitatID" dataType="Integer" isPrimary="True" />
                <column name="Iteration" dataType="Integer" validationType="WholeNumber" validationCondition="Greater" formula1="0" format="d" isOptional="True" />
                <column name="Timestep" dataType="Integer" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="0" isOptional="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="RangeID" dataType="Integer" validationType="Datasheet" formula1="CaribouRange" allowDbNull="False" />
                <column name="SeasonID" dataType="Integer" validationType="Datasheet" formula1="Season" allowDbNull="False" />
                <column name="FileName" dataType="String" isExternalFile="True" isRaster="True" bandColumn="Band" bandFilterColumn="SeasonID" allowDbNull="False" filenameCode="habuse" />
                <column name="Band" dataType="Integer" isOptional="True" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>
        
        <datafeed name="OutputHabitat" displayName="Output Habitat " dataScope="Scenario" isOutput="True">
          <datasheets>
            <datasheet name="OutputHabitat" displayName="Output Habitat">
              <columns>
                <column name="OutputHabitatID" dataType="Integer" isPrimary="True" />
                <column name="Iteration" dataType="Integer" validationType="WholeNumber" validationCondition="Greater" formula1="0" format="d" isOptional="True" />
                <column name="Timestep" dataType="Integer" validationType="WholeNumber" validationCondition="GreaterEqual" formula1="0" isOptional="True" />
                <column name="ScenarioID" dataType="Integer" />
                <column name="RangeID" dataType="Integer" validationType="Datasheet" formula1="CaribouRange" allowDbNull="False" />
                <column name="SeasonID" dataType="Integer" validationType="Datasheet" formula1="Season" allowDbNull="False" />
                <column name="Amount" dataType="Integer" />
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>

      </datafeeds>

      <pipeline>

        <!--datafeed name="DataSummary" /-->
        <datafeed name="RasterFile" />
        <datafeed name="ExternalFile" />
        <datafeed name="CaribouDataSource" />
        <datafeed name="RunControl" />
        <datafeed name="RunCaribouRange" />
        <datafeed name="HabitatModelOptions" />

      </pipeline>

    </transformer>

  </transformers>

  <!-- Layouts -->
  <layouts>

    <!-- Core feeds layouts -->
    <layout name="coreforms_LibraryDatafeeds">

      <item name="core_SysFolder" />
      <item name="core_Backup" />
      <item name="core_Multiprocessing" />
      <item name="core_Options" />
      <item name="core_Rconfig" />

    </layout>

    <!-- Project feeds layouts -->
    <layout name="coreforms_ProjectDatafeeds">

      <group name="Variables">
        <item name="SpaDESSimObject" />
        <!-- item name="Variable"/ -->
        <item name="Rasters" />
        <item name="Polygons" />
      </group>

      <group name="CaribouModel" displayName="Caribou Metrics">
        <item name="CaribouRange" />
        <item name="Season" />
      </group>

      <group name="Pipeline">
        <item name="core_Transformer" />
        <item name="core_StageName" />
        <item name="core_StageValue" />
      </group>

    </layout>

    <!-- Scenario feeds layouts -->
    <layout name="coreforms_ScenarioDatafeeds">

      <group name="RunControl" displayName="Run Control">
        <item name="core_Pipeline"/>
        <item name="RunControl"/>
      </group>

      <group name="SpaDES" displayName="SpaDES">

        <group name="Inputs">
          <item name="SpaDESGeneral" displayName="General" itemTransformer="LoadSpadesOutputs" showIf="isParent" />
          <!--item name="SpaDESRuntimeVariables" /-->
          <item name="SpaDESRuntimeRasters" itemTransformer="LoadSpadesOutputs" showIf="isParent" />
          <item name="SpaDESRuntimeFiles" itemTransformer="LoadSpadesOutputs" showIf="isParent" />
        </group>

        <group name="Outputs">
          <!--item name="DataSummary" /-->
          <item name="RasterFile" itemTransformer="LoadSpadesOutputs" showIf="isResult" />
          <item name="ExternalFile" itemTransformer="LoadSpadesOutputs" showIf="isResult" />
        </group>

      </group>

      <group name="makeLCCFromCohortData" displayName="Cohort to LCC">

        <group name="Inputs">
          <item name="SpaDESGeneral" itemTransformer="makeLCCFromCohortData" showIf="isParent"/>
        </group>

        <group name="Outputs">
          <item name="RasterFile" itemTransformer="makeLCCFromCohortData" showIf="isResult"/>
        </group>

      </group>

      <group name="CaribouModel" displayName="Caribou Metrics">

        <group name="Inputs">
          <item name="RunCaribouRange" itemTransformer="RunCaribouHabitatModel" showIf="isParent" />
          <item name="CaribouDataSource" itemTransformer="RunCaribouHabitatModel" showIf="isParent" />
          <item name="HabitatModelOptions" itemTransformer="RunCaribouHabitatModel" showIf="isParent"/>
          <item name="RasterFile" itemTransformer="RunCaribouHabitatModel" showIf="isParent" />
          <item name="ExternalFile" itemTransformer="RunCaribouHabitatModel" showIf="isParent" />
        </group>

        <group name="Outputs">
          <item name="OutputHabitat" itemTransformer="RunCaribouHabitatModel" showIf="isResult" />
          <item name="OutputSpatialHabitat" itemTransformer="RunCaribouHabitatModel" showIf="isResult" />
        </group>
        
      </group>

    </layout>

    <!--Results transformer Layout-->
    <layout name="coreforms_ResultTransformers">
      
      <!--item name="corestime_ChartTransformer" /-->
      <item name="corestime_MapTransformer" />

    </layout>

    <!--layout name="corestimeforms_Charts" configurationSheet="RunControl">
      <item name="DataSummary" displayName="Data Summary" dataSheet="DataSummary" column="Value" variableSourceColumn="VariableID" />
    </layout -->

    <!--Maps Layout-->
    <layout name="corestimeforms_Maps" configurationSheet="ROFSim_RunControl">
      <!-- TODO add colorMapSource="stsim_TransitionType" -->
      <item name="InputRastersMap" displayName="Rasters Variables" dataSheet="RasterFile" column="Filename" filter="RastersID" />
      <item name="OutputRastersMap" displayName="Habitat Use (Spatial)" dataSheet="OutputSpatialHabitat" column="FileName" filter="SeasonID" />
    </layout>

  </layouts>

  <!--views>
    <view name="DataSummaryDataFeedView" target="DataSummary" className="SyncroSim.Core.Forms.FilteredDataFeedView" classAssembly="SyncroSim.Core.Forms" />
  </views-->

</package>